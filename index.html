<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Topâ€‘25 CFB Live Scoreboard â€¢ CFBD â€¢ GitHub Pages</title>
  <!--
    HOW THIS WORKS (GitHubâ€‘only, no backend):
    - Two modes via URL param: ?mode=control (your browser) and ?mode=display (OBS/browser for viewers).
    - Control page can pull realâ€‘time data from the CollegeFootballData (CFBD) REST API and push the
      normalized scoreboard to Display via a WebRTC data channel (manual copy/paste pairing â€” no servers).
    - Your CFBD API key is entered only on the CONTROL page and stored in localStorage; it is NOT embedded
      in the repo. Do NOT put your key into this file.

    LEGAL: This is YOUR original UI. Do not show thirdâ€‘party broadcast video/audio or screenshots.
  -->
  <style>
    :root{
      --bg:#0b0b0b; --ink:#fff; --muted:#bdbdbd; --glass:rgba(255,255,255,.06); --line:#1f1f1f;
      --accent:#8a2be2; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
    a{color:var(--accent);text-decoration:none}
    .page{max-width:1200px;margin:0 auto;padding:14px}
    .topbar{display:flex;gap:10px;align-items:center;margin:4px 0 12px}
    .topbar h1{font-size:18px;margin:0;font-weight:800}
    .grow{flex:1}
    .tip{background:var(--glass);border:1px solid var(--line);padding:6px 10px;border-radius:12px;display:flex;gap:8px;align-items:center}
    .tip input{background:#171717;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:6px 8px;min-width:200px}
    .btn{background:#1e1e1e;border:1px solid #2a2a2a;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#242424}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}

    /* DISPLAY GRID (responsive: phone â†’ desktop) */
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:740px){.grid{grid-template-columns:1fr 1fr}}
    @media(min-width:1080px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--glass);border:1px solid var(--line);border-radius:14px;padding:10px}
    .head{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px}
    .teams{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .team{display:flex;flex-direction:column;gap:2px}
    .name{font-weight:800;font-size:14px}
    .score{font-weight:900;font-size:22px}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-weight:600;color:var(--muted)}
    .ticker{margin-top:8px;background:#0f0f0f;border:1px dashed #2a2a2a;border-radius:10px;padding:8px;font-size:13px}

    /* CONTROL PANEL */
    .panel{margin-top:12px;background:#0f0f0f;border:1px solid #222;border-radius:14px;padding:12px}
    .panel h2{margin:0 0 8px;font-size:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel input,.panel select,.panel textarea{background:#171717;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:6px 8px}
    .panel textarea{min-height:44px}
    .hr{height:1px;background:#1d1d1d;margin:10px 0}

    /* P2P */
    .p2p{margin-top:12px;background:#0f0f0f;border:1px solid #222;border-radius:14px;padding:12px}
    .p2p textarea{width:100%;min-height:110px;background:#171717;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:8px}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color:#9cffb0}

    /* Sponsor strip (optional) */
    .sponsors{margin:12px 0 0;display:flex;gap:10px;flex-wrap:wrap}
    .sponsors .slot{background:#101010;border:1px dashed #2a2a2a;border-radius:10px;padding:6px 10px;font-size:12px}

    /* Shoutouts ticker */
    .shout{margin-top:8px;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:10px;padding:8px;font-weight:700;white-space:nowrap;overflow:hidden}
    .shout span{display:inline-block;padding-right:24px}
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <h1>Topâ€‘25 College Football Live Board</h1>
      <div class="grow"></div>
      <div class="tip" id="tipBox">
        <span>Tip the show:</span>
        <input id="tipText" placeholder="e.g., BuyMeACoffee: tigerfan"/>
        <input id="tipUrl" placeholder="https://your-tip-link"/>
        <button class="btn" id="saveTip">Set</button>
      </div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="sponsors" id="sponsors"></div>
    <div class="shout" id="shout" style="display:none"></div>

    <!-- CONTROL UI (only visible in ?mode=control) -->
    <div class="panel" id="control" style="display:none">
      <h2>Control</h2>
      <div class="row">
        <label>CFBD API Key <input id="cfbdKey" placeholder="Paste your CFBD key" size="36"></label>
        <label>Season <input id="yearIn" type="number" value="2025" style="width:90px"></label>
        <label>Week <input id="weekIn" type="number" value="2" style="width:80px"></label>
        <label>Season Type <select id="seasonType"><option value="regular">regular</option><option value="postseason">postseason</option></select></label>
        <label>Poll <select id="poll"><option value="AP">AP</option><option value="Coaches">Coaches</option></select></label>
        <label>Poll Every (sec) <input id="freqIn" type="number" value="10" style="width:80px"></label>
        <button class="btn" id="start">Start CFBD</button>
        <button class="btn" id="stop">Stop</button>
      </div>
      <div class="row">
        <label>Manual Shoutouts <input id="shoutIn" placeholder="e.g., Thanks Sam ($10)!; New Member: Alex"></label>
        <button class="btn" id="shoutBtn">Update Shouts</button>
        <label>Affiliate/Sponsor Text <input id="sponsorIn" placeholder="e.g., Use code TIGER for 10% off at Example.com"></label>
        <button class="btn" id="sponsorBtn">Set Sponsors</button>
      </div>
      <div class="hr"></div>
      <div class="hint">Tip: Your key is stored locally in this browser only (localStorage). Donâ€™t commit it to GitHub.</div>
    </div>

    <!-- P2P LINKING (manual signaling) -->
    <div class="p2p" id="p2p">
      <div class="row" style="justify-content:space-between"><strong>Peerâ€‘toâ€‘Peer Link</strong><span class="hint" id="p2pStatus">idle</span></div>
      <div id="p2pControl" style="display:none">
        <p class="hint">Control â†’ Display: 1) Create Offer, 2) paste into Display (OBS), 3) copy Answer back here and apply.</p>
        <button class="btn" id="makeOffer">Create Offer</button>
        <textarea id="offerOut" placeholder="Your Offerâ€¦"></textarea>
        <textarea id="answerIn" placeholder="Paste Answer from display hereâ€¦"></textarea>
        <button class="btn" id="applyAnswer">Apply Answer</button>
      </div>
      <div id="p2pDisplay" style="display:none">
        <p class="hint">Display (OBS): paste the controllerâ€™s Offer below â†’ Generate Answer â†’ copy back.</p>
        <textarea id="offerIn" placeholder="Paste Offer from controlâ€¦"></textarea>
        <button class="btn" id="makeAnswer">Generate Answer</button>
        <textarea id="answerOut" placeholder="Copy this Answer back to the controllerâ€¦"></textarea>
      </div>
    </div>
  </div>

  <script>
    // ======== STATE ========
    const state = {
      tipText:'Support the show', tipUrl:'',
      shout:[], sponsors:[],
      games: [] // normalized array of {id, rank, status, home:{name,score}, away:{name,score}, quarter, clock, down, distance, yardLine, possession, lastPlay}
    };

    // ======== RENDER DISPLAY ========
    const gridEl = document.getElementById('grid');
    function card(g){
      const ord = ['1st','2nd','3rd','4th'][g.quarter-1] || (g.quarter===5?'OT':(g.quarter||'â€”'));
      const statusClr = g.status==='Live'? 'var(--good)': g.status==='Final'? 'var(--bad)':'var(--warn)';
      const poss = g.possession||'';
      return `
        <div class="card">
          <div class="head">
            <div class="row" style="gap:8px">
              <span class="pill" style="border-color:${statusClr};color:${statusClr}">${g.status||'â€”'}</span>
              ${g.rank?`<span class="pill">Top ${g.rank}</span>`:''}
            </div>
            <div class="pill" style="background:#141414">${ord} ${g.clock||''}</div>
          </div>
          <div class="teams">
            <div class="team"><span class="name">${g.home.name}</span><span class="score">${g.home.score??0}</span></div>
            <div class="pill">vs</div>
            <div class="team" style="align-items:end;text-align:right"><span class="name">${g.away.name}</span><span class="score">${g.away.score??0}</span></div>
          </div>
          <div class="meta">
            ${g.down?`<span>${['1st','2nd','3rd','4th'][g.down-1]||g.down} & ${g.distance||''}</span>`:''}
            ${g.yardLine?`<span>â€¢ On ${g.yardLine}</span>`:''}
            ${poss?`<span>â€¢ POS: ${poss}</span>`:''}
          </div>
          <div class="ticker">${g.lastPlay||''}</div>
        </div>`
    }
    function render(){
      // Tip banner
      const tipBox=document.getElementById('tipBox');
      if(location.search.includes('mode=display')){
        tipBox.innerHTML = state.tipUrl ?
          `<span>Tip the show:</span> <a href="${state.tipUrl}" target="_blank" rel="noopener">${state.tipText||state.tipUrl}</a>` :
          `<span>Tip the show:</span> <span class="hint">set a link from control</span>`;
      }
      // Sponsors
      const sponsors=document.getElementById('sponsors');
      sponsors.innerHTML = state.sponsors.map(t=>`<div class="slot">${t}</div>`).join('');
      // Shoutouts ticker
      const shout=document.getElementById('shout');
      if(state.shout.length){ shout.style.display='block'; shout.innerHTML = state.shout.map(n=>`<span>ðŸŽ‰ ${n}</span>`).join(''); }
      else shout.style.display='none';
      // Grid
      const sorted=[...state.games].sort((a,b)=> (a.rank||99)-(b.rank||99));
      gridEl.innerHTML = sorted.map(card).join('');
    }

    // ======== CONTROL UI ========
    const isControl = location.search.includes('mode=control');
    if(isControl){
      document.getElementById('control').style.display='block';
      document.getElementById('p2pControl').style.display='block';
      // restore key and tip text
      const k = localStorage.getItem('cfbdKey'); if(k) document.getElementById('cfbdKey').value = k;
      const tt = localStorage.getItem('tipText'); const tu = localStorage.getItem('tipUrl');
      if(tt) document.getElementById('tipText').value = tt; if(tu) document.getElementById('tipUrl').value = tu;
      document.getElementById('saveTip').onclick=()=>{ state.tipText=document.getElementById('tipText').value; state.tipUrl=document.getElementById('tipUrl').value; localStorage.setItem('tipText',state.tipText); localStorage.setItem('tipUrl',state.tipUrl); send(); render(); };
      document.getElementById('shoutBtn').onclick=()=>{ const txt=document.getElementById('shoutIn').value||''; state.shout = txt.split(';').map(s=>s.trim()).filter(Boolean); send(); render(); };
      document.getElementById('sponsorBtn').onclick=()=>{ const txt=document.getElementById('sponsorIn').value||''; state.sponsors = txt.split(';').map(s=>s.trim()).filter(Boolean); send(); render(); };
    } else {
      document.getElementById('p2pDisplay').style.display='block';
    }

    // ======== CFBD INTEGRATION (CONTROL SIDE) ========
    let pollTimer=null;
    async function cfbdFetch(path, key){
      const url = `https://api.collegefootballdata.com${path}`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${key}` } });
      if(!res.ok) throw new Error('CFBD error '+res.status);
      return res.json();
    }
    function storeKey(){ const key=document.getElementById('cfbdKey').value.trim(); if(key) localStorage.setItem('cfbdKey',key); return key; }

    async function loadTop25Games(){
      const key = storeKey();
      const year = +document.getElementById('yearIn').value;
      const week = +document.getElementById('weekIn').value;
      const seasonType = document.getElementById('seasonType').value;
      const poll = document.getElementById('poll').value;

      // 1) Get Topâ€‘25 teams for the week
      // GET /rankings?year=&week=&seasonType=&poll=AP
      let top25=[];
      try{
        const ranks = await cfbdFetch(`/rankings?year=${year}&week=${week}&seasonType=${seasonType}&poll=${encodeURIComponent(poll)}`, key);
        const pollObj = (ranks||[])[0]?.polls?.find?.(p=>p.poll===poll) || (ranks||[])[0];
        const entries = pollObj?.ranks || pollObj?.entries || [];
        top25 = entries.slice(0,25).map(r=> (r.school||r.team||r.name) );
      }catch(e){ console.warn('Rankings fetch failed', e); }

      // 2) Get live scoreboard for the week (try /scoreboard then /live/scoreboard)
      let board = [];
      try{
        board = await cfbdFetch(`/scoreboard?year=${year}&week=${week}&seasonType=${seasonType}`, key);
      }catch(e1){
        try{ board = await cfbdFetch(`/live/scoreboard?year=${year}&week=${week}&seasonType=${seasonType}`, key); }
        catch(e2){ console.error('Scoreboard fetch failed', e1, e2); return; }
      }
      // 3) Normalize + filter to Topâ€‘25 matchups
      const keep = new Set(top25);
      const games = (board||[]).filter(g=> keep.has(get(g,'homeTeam','home_team')) || keep.has(get(g,'awayTeam','away_team')) ).map(normalizeGame);
      // 4) Enrich with rank (Topâ€‘25 rank for home/away if available)
      const rankMap = new Map(top25.map((t,i)=>[t,i+1]));
      games.forEach(g=>{ const rH=rankMap.get(g.home.name); const rA=rankMap.get(g.away.name); g.rank = Math.min(rH||99, rA||99); if(!isFinite(g.rank)) g.rank=99; });
      state.games = games; send(); render();
    }

    function normalizeGame(g){
      const homeName = get(g,'homeTeam','home_team','home');
      const awayName = get(g,'awayTeam','away_team','away');
      const homeScore = num(get(g,'homeScore','home_points','home_points_total'))||0;
      const awayScore = num(get(g,'awayScore','away_points','away_points_total'))||0;
      const period = num(get(g,'period','quarter','current_period'))|| (get(g,'status')==='final'?4:1);
      const clock = get(g,'clock','game_clock','display_clock')||'';
      const statusRaw = (get(g,'status')||get(g,'gameStatus')||'').toString().toLowerCase();
      const status = statusRaw.includes('final')? 'Final' : statusRaw.includes('in')||statusRaw.includes('live')? 'Live' : 'Scheduled';
      const down = num(get(g,'down','current_down'))||undefined;
      const distance = num(get(g,'distance','current_distance'))||undefined;
      const yardLine = get(g,'yardLine','yard_line','field_position')||'';
      const possession = get(g,'possession','possessionTeam','pos_team')||'';
      const lastPlay = get(g,'lastPlay','last_play')||'';
      return { id: get(g,'id','gameId','game_id')||(`${homeName}-${awayName}`), rank:99, status,
        home:{name:homeName, score:homeScore}, away:{name:awayName, score:awayScore},
        quarter: period, clock, down, distance, yardLine, possession, lastPlay };
    }
    function get(o,...keys){ for(const k of keys){ if(o && o[k]!=null) return o[k]; } return undefined; }
    function num(v){ const n=Number(v); return isFinite(n)?n:undefined; }

    // Start/Stop polling
    if(isControl){
      document.getElementById('start').onclick=()=>{ const key=storeKey(); if(!key){ alert('Enter your CFBD API key'); return; } const freq = Math.max(5, +document.getElementById('freqIn').value||10); if(pollTimer) clearInterval(pollTimer); loadTop25Games(); pollTimer = setInterval(loadTop25Games, freq*1000); };
      document.getElementById('stop').onclick=()=>{ if(pollTimer) clearInterval(pollTimer); pollTimer=null; };
    }

    // ======== P2P (manual signaling, one data channel) ========
    let pc, dc; const rtcCfg={ iceServers:[{urls:'stun:stun.l.google.com:19302'}] };
    const statusEl = document.getElementById('p2pStatus');
    function setStatus(txt,ok){ statusEl.textContent=txt; statusEl.className= ok? 'hint ok':'hint'; }
    function send(){ if(dc && dc.readyState==='open'){ dc.send(JSON.stringify(state)); } }
    async function waitIceComplete(p){ return new Promise(res=>{ if(p.iceGatheringState==='complete') return res(); p.addEventListener('icegatheringstatechange',()=>{ if(p.iceGatheringState==='complete') res();});}); }

    if(isControl){
      // Controller
      const offerBtn=document.getElementById('makeOffer');
      const offerOut=document.getElementById('offerOut');
      const answerIn=document.getElementById('answerIn');
      const applyBtn=document.getElementById('applyAnswer');
      pc=new RTCPeerConnection(rtcCfg);
      dc=pc.createDataChannel('board',{ordered:true});
      dc.onopen=()=>{ setStatus('Connected',true); send(); };
      dc.onclose=()=>setStatus('Closed');
      offerBtn.onclick=async()=>{ const offer=await pc.createOffer(); await pc.setLocalDescription(offer); await waitIceComplete(pc); offerOut.value=JSON.stringify(pc.localDescription); setStatus('Offer ready â€” paste into display',true); };
      applyBtn.onclick=async()=>{ const ansTxt=answerIn.value.trim(); if(!ansTxt) return; const ans=JSON.parse(ansTxt); await pc.setRemoteDescription(new RTCSessionDescription(ans)); setStatus('Answer applied â€” connectingâ€¦'); };
    }else{
      // Display
      document.getElementById('p2pDisplay').style.display='block';
      pc=new RTCPeerConnection(rtcCfg);
      pc.ondatachannel=(ev)=>{ dc=ev.channel; dc.onopen=()=>setStatus('Connected',true); dc.onmessage=(m)=>{ try{ const incoming=JSON.parse(m.data); Object.assign(state,incoming); render(); }catch(e){} }; dc.onclose=()=>setStatus('Closed'); };
      const offerIn=document.getElementById('offerIn');
      const makeAnswer=document.getElementById('makeAnswer');
      const answerOut=document.getElementById('answerOut');
      makeAnswer.onclick=async()=>{ const off=JSON.parse(offerIn.value.trim()); await pc.setRemoteDescription(new RTCSessionDescription(off)); const ans=await pc.createAnswer(); await pc.setLocalDescription(ans); await waitIceComplete(pc); answerOut.value=JSON.stringify(pc.localDescription); setStatus('Answer ready â€” send back to control',true); };
    }

    // Initial paint
    render();
  </script>
</body>
</html>
