<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Top-25 College Football — Live Board (CFBD)</title>
<style>
:root{--bg:#0b0b0b;--ink:#fff;--muted:#bfbfbf;--glass:rgba(255,255,255,.06);--line:#1d1d1d;--accent:#8a2be2;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--chip:#141414}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
.wrap{max-width:1280px;margin:0 auto;padding:12px}
.ctrl{position:sticky;top:0;z-index:100;background:rgba(0,0,0,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);padding:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.ctrl input,.ctrl select{background:#171717;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:6px 8px}
.btn{background:#1f1f1f;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn:hover{background:#272727}
.pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:var(--chip);font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
@media(min-width:820px){.grid{grid-template-columns:1fr 1fr}}
.card{background:var(--glass);border:1px solid var(--line);border-radius:14px;padding:10px}
.head{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px}
.teams{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
.team{display:flex;gap:8px;align-items:center}
.logo{width:22px;height:22px;border-radius:6px;background:#222;display:inline-flex;align-items:center;justify-content:center;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:contain}
.name{font-weight:800;font-size:14px}
.rank{font-weight:900;margin-right:6px;opacity:.9}
.score{font-weight:900;font-size:22px}
.vs{font-weight:700;color:#cfcfcf}
.meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-weight:600;color:var(--muted)}
.ticker{margin-top:8px;background:#0f0f0f;border:1px dashed #2a2a2a;border-radius:10px;padding:8px;font-size:13px}
.field{margin-top:8px;position:relative;height:70px;background:#0a7a28;border:3px solid #ddd;border-radius:12px;overflow:hidden}
.yd{position:absolute;top:0;bottom:0;width:2px;background:rgba(255,255,255,.35)}
.num{position:absolute;bottom:4px;color:#fff;font-weight:800;font-size:10px;opacity:.9;transform:translateX(-50%)}
.ball{position:absolute;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;background:#c66;border:2px solid #5a2d14;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.45);transition:left .45s ease}
.trail{position:absolute;top:50%;height:4px;background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.9),rgba(255,255,255,0));transform:translateY(-50%);opacity:0;transition:opacity .35s ease}
.picker{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:200}
.pickbox{width:min(900px,95vw);max-height:82vh;overflow:auto;background:#0f0f0f;border:1px solid #222;border-radius:16px;padding:14px}
.pickcols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.picklist{border:1px solid #222;border-radius:12px;padding:8px}
.pickrow,.orderrow{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px solid #1a1a1a;padding:6px 0}
.pickrow:last-child,.orderrow:last-child{border-bottom:none}
.small{font-size:12px;color:#bbb}
</style>
</head>
<body>
  <div class="ctrl">
    <div class="row">
      <strong>Top-25 CFB Live Board</strong>
      <span id="status" class="pill">idle</span>
      <span class="small">Paste CFBD key → pick season/week → Start. Default: AP Top-25 by rank.</span>
    </div>
    <div class="row" style="margin-top:6px">
      <label>CFBD Key <input id="keyIn" placeholder="paste your key" size="38"></label>
      <label>Season <input id="yearIn" type="number" value="2025" style="width:90px"></label>
      <label>Week <input id="weekIn" type="number" value="2" style="width:80px"></label>
      <label>Type <select id="seasonType"><option value="regular">regular</option><option value="postseason">postseason</option></select></label>
      <label>Poll <select id="poll"><option value="AP">AP</option><option value="Coaches">Coaches</option></select></label>
      <label>Interval <select id="interval"><option value="120">120s</option><option value="180">180s</option><option value="60">60s</option></select></label>
      <button class="btn" id="thisWeek">This Week</button>
      <button class="btn" id="testKey">Test Key</button>
      <button class="btn" id="start">Start</button>
      <button class="btn" id="stop">Stop</button>
      <label class="pill"><input type="checkbox" id="logosToggle" checked> Show logos</label>
      <label class="pill"><input type="checkbox" id="safeMode" checked> Free-tier safe</label>
      <button class="btn" id="pickBtn">Pick & Order</button>
    </div>
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
  </div>

  <!-- Picker -->
  <div id="picker" class="picker">
    <div class="pickbox">
      <div class="row" style="margin-bottom:8px">
        <h3 style="margin-right:auto">Pick up to 10 (Add → order → Apply)</h3>
        <button class="btn" data-action="close">Close</button>
        <button class="btn" data-action="clear">Clear</button>
        <button class="btn" data-action="top25">Auto Top-25</button>
        <button class="btn" data-action="apply">Apply</button>
      </div>
      <div class="pickcols">
        <div class="picklist">
          <div class="small">All FBS games this week (rank shown when applicable)</div>
          <div id="pickLeft"></div>
        </div>
        <div class="picklist">
          <div class="small">Your Top-10 (↑/↓/Remove)</div>
          <div id="pickRight"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
const S = {
  allGames: [],
  games: [],
  rankMap: new Map(),
  logos: new Map(),
  fbsSet: new Set(),
  selected: [],
  featured: new Set()
};
let pollTimer=null, playsTimer=null;

function setStatus(t, ok){ const s=$('status'); s.textContent=t; s.className='pill'+(ok?' ok':''); }
function saveKey(){ localStorage.setItem('cfbdKey', $('keyIn').value.trim()); }
function loadKey(){ const k=localStorage.getItem('cfbdKey'); if(k) $('keyIn').value=k; }

async function cfbd(path){
  const key=$('keyIn').value.trim(); if(!key) throw new Error('Missing key');
  const r=await fetch(`https://api.collegefootballdata.com${path}`,{headers:{Authorization:`Bearer ${key}`}});
  if(!r.ok){ let t=''; try{t=await r.text();}catch{} throw new Error(`CFBD ${r.status} ${r.statusText}${t?' — '+t.slice(0,120):''}`); }
  return r.json();
}

async function resolveWeek(){
  const year=+$('yearIn').value, st=$('seasonType').value;
  const cal=await cfbd(`/calendar?year=${year}`);
  const today=new Date().toISOString().slice(0,10);
  const slot=cal.find(w=>w.seasonType===st && today>=w.startDate && today<=w.endDate);
  if(slot) $('weekIn').value=slot.week;
}

async function loadFbsAndLogos(){
  if(S.fbsSet.size && (S.logos.size || !$('logosToggle').checked)) return;
  const teams=await cfbd(`/teams/fbs?year=${$('yearIn').value}`);
  teams.forEach(t=>{
    S.fbsSet.add(t.school);
    const u=(t.logos&&t.logos[0])||t.logo||''; if(u) S.logos.set(t.school,u);
  });
}
function logoFor(n){ const u=S.logos.get(n); return $('logosToggle').checked && u ? `<span class="logo"><img src="${u}" alt=""></span>`:`<span class="logo">${n.split(' ').map(s=>s[0]).join('').slice(0,3)}</span>`; }
function rankTag(n){ const r=S.rankMap.get(n); return r? `<span class="rank">#${r}</span>`:''; }
function num(v){ const n=Number(v); return isFinite(n)?n:undefined; }
function get(o,...k){ for(const x of k){ if(o && o[x]!=null) return o[x]; } }
function toPct(yl){ if(!yl && yl!==0) return 50; const m=String(yl).match(/(\d+)/); const n=m?+m[1]:+yl; return isFinite(n)?Math.max(0,Math.min(100,n)):50; }
function kickStr(g){ const dt=get(g,'startDate','start_date','start'); return dt? `Kick: ${String(dt).slice(0,16)}`:''; }

function norm(g){
  const home=get(g,'homeTeam','home_team','home'), away=get(g,'awayTeam','away_team','away');
  const id=get(g,'id','gameId','game_id') || `${home}-${away}`;
  return {
    id,
    home:{name:home, score:num(get(g,'homeScore','home_points','home_points_total'))||0},
    away:{name:away, score:num(get(g,'awayScore','away_points','away_points_total'))||0},
    status:(get(g,'status')||get(g,'gameStatus')||'').toString(),
    quarter:num(get(g,'period','quarter','current_period'))||0,
    clock:get(g,'clock','game_clock','display_clock')||'',
    down:num(get(g,'down','current_down')), distance:num(get(g,'distance','current_distance')),
    yardLine:get(g,'yardLine','yard_line','field_position')||'',
    possession:get(g,'possession','possessionTeam','pos_team')||'',
    lastPlay:get(g,'lastPlay','last_play')||'',
    kickoff:kickStr(g), prevYL:undefined
  };
}

async function loadData(){
  setStatus('loading…');
  await loadFbsAndLogos();
  const year=+$('yearIn').value, week=+$('weekIn').value, st=$('seasonType').value, poll=$('poll').value;

  // rankings
  let top25=[]; try{
    const rr=await cfbd(`/rankings?year=${year}&week=${week}&seasonType=${st}&poll=${encodeURIComponent(poll)}`);
    const po=(rr||[])[0]?.polls?.find?.(p=>p.poll===poll)||(rr||[])[0]; const ents=po?.ranks||po?.entries||[];
    top25=ents.map(x=>x.school||x.team||x.name);
  }catch{} S.rankMap=new Map(top25.map((t,i)=>[t,i+1]));

  // games (prefer scoreboard), then filter to FBS (either team in FBS Set)
  let raw=[]; let used='scoreboard';
  try{ raw=await cfbd(`/scoreboard?year=${year}&week=${week}&seasonType=${st}&classification=fbs`);}catch{}
  if(!raw || !raw.length){ try{ raw=await cfbd(`/games?year=${year}&week=${week}&seasonType=${st}&division=fbs`); used='games'; }catch{} }
  // Extra safety filter: only show matchups where at least one team is FBS
  const fbsOnly=(raw||[]).filter(g=> S.fbsSet.has(get(g,'homeTeam','home_team','home')) || S.fbsSet.has(get(g,'awayTeam','away_team','away')) );
  if(!fbsOnly.length){ S.allGames=[]; S.games=[]; setStatus(`No FBS games for ${year} Wk ${week}`,false); render(); return; }

  S.allGames=fbsOnly.map(norm);

  if(!S.selected.length){
    const rm=S.rankMap;
    const ranked=S.allGames
      .filter(g=>rm.has(g.home.name)||rm.has(g.away.name))
      .map(g=>({g,rank:Math.min(rm.get(g.home.name)||99, rm.get(g.away.name)||99)}))
      .sort((a,b)=>a.rank-b.rank).map(x=>x.g);
    S.games=(ranked.length? ranked:S.allGames).slice(0,10);
  }else{
    const map=new Map(S.allGames.map(g=>[g.id,g]));
    S.games=S.selected.map(id=>map.get(id)).filter(Boolean).slice(0,10);
  }

  setStatus(used==='scoreboard'?'ready':'ready (fallback)',true);
  render();
}

async function fetchPlays(gameId){
  try{
    const plays=await cfbd(`/live/plays?gameId=${gameId}`); if(!plays||!plays.length) return;
    const last=plays[plays.length-1], g=S.games.find(x=>x.id===gameId); if(!g) return;
    g.prevYL=toPct(g.yardLine); g.yardLine=last.yardLine||last.yard||g.yardLine;
    g.down=Number(last.down)||g.down; g.distance=Number(last.distance)||g.distance; g.possession=last.offense||g.possession;
    if(typeof last.homeScore==='number') g.home.score=last.homeScore;
    if(typeof last.awayScore==='number') g.away.score=last.awayScore;
    g.lastPlay=last.text||last.playText||g.lastPlay;
    if(Number(last.period)) g.quarter=Number(last.period);
    if(last.clock) g.clock=last.clock;
    render(true);
  }catch{}
}
function startTimers(){
  stopTimers();
  const sec=+$('interval').value;
  pollTimer=setInterval(loadData, sec*1000);
  playsTimer=setInterval(async()=>{
    const ids=[...S.featured]; const pick=($('safeMode').checked?ids.slice(0,2):ids.slice(0,5));
    for(const id of pick) await fetchPlays(id);
  }, Math.max(15,sec/2)*1000);
}
function stopTimers(){ if(pollTimer) clearInterval(pollTimer); if(playsTimer) clearInterval(playsTimer); pollTimer=playsTimer=null; }

function cardHTML(g){
  const sl=(g.status||'').toLowerCase();
  let status='—'; if(sl.includes('final')) status='Final'; else if(sl.includes('in')||sl.includes('live')) status='Live'; else if(sl.includes('sched')) status='Scheduled'; else status=(g.status||'—');
  const q=g.quarter||0, ord=q? (['1st','2nd','3rd','4th'][q-1]||(q===5?'OT':q)) : '—';
  const boosted=S.featured.has(g.id);
  const yl=toPct(g.yardLine), trail=(g.prevYL!=null)? `<div class="trail" style="left:${Math.min(g.prevYL,yl)}%;width:${Math.abs(yl-(g.prevYL||yl))}%;opacity:.85"></div>`:'';
  return `<div class="card" id="card-${g.id}">
    <div class="head">
      <div class="row" style="gap:8px">
        <span class="pill" style="border-color:${status==='Live'?'var(--good)':status==='Final'?'var(--bad)':'var(--warn)'};color:${status==='Live'?'var(--good)':status==='Final'?'var(--bad)':'var(--warn)'}">${status}</span>
        <span class="pill">${ord}${g.clock?' • '+g.clock:(!g.clock && status!=='Live' && g.kickoff? ' • '+g.kickoff:'')}</span>
      </div>
      <button class="btn" data-boost="${g.id}">${boosted?'Boosted ✅':'Boost'}</button>
    </div>
    <div class="teams">
      <div class="team">${logoFor(g.home.name)}${rankTag(g.home.name)}<span class="name">${g.home.name}</span><span class="score">${g.home.score}</span></div>
      <div class="vs">vs</div>
      <div class="team" style="justify-content:flex-end">${logoFor(g.away.name)}${rankTag(g.away.name)}<span class="name">${g.away.name}</span><span class="score">${g.away.score}</span></div>
    </div>
    <div class="meta">
      ${g.down?`<span>${['1st','2nd','3rd','4th'][g.down-1]||g.down} & ${g.distance||''}</span>`:''}
      ${g.yardLine?`<span>• On ${g.yardLine}</span>`:''}
      ${g.possession?`<span>• POS: ${g.possession}</span>`:''}
    </div>
    <div class="field" data-id="${g.id}">
      ${[10,20,30,40,50,60,70,80,90].map(x=>`<div class="yd" style="left:${x}%"></div><div class="num" style="left:${x}%">${x}</div>`).join('')}
      ${trail}<div class="ball" style="left:${yl}%"></div>
    </div>
    <div class="ticker">${g.lastPlay||''}</div>
  </div>`;
}
function render(partial){
  const grid=$('grid');
  if(!partial){
    grid.innerHTML=S.games.map(cardHTML).join('');
    grid.querySelectorAll('button[data-boost]').forEach(b=>{
      b.onclick=()=>{ const id=b.dataset.boost; if(S.featured.has(id)) S.featured.delete(id); else S.featured.add(id); render(); };
    });
  }else{
    S.games.forEach(g=>{
      const field=document.querySelector(`.field[data-id="${g.id}"]`); if(!field) return;
      const ball=field.querySelector('.ball'); const trail=field.querySelector('.trail');
      const yl=toPct(g.yardLine); ball.style.left=`${yl}%`;
      if(trail){ trail.style.left=`${Math.min(g.prevYL||yl,yl)}%`; trail.style.width=`${Math.abs(yl-(g.prevYL||yl))}%`; trail.style.opacity='0.85'; setTimeout(()=>{ if(trail) trail.style.opacity='0'; }, 900); }
      const card=document.getElementById(`card-${g.id}`); if(card){ card.querySelector('.ticker').textContent=g.lastPlay||''; }
    });
  }
}

/* -------- Picker (robust click handling) -------- */
function openPicker(){ buildPicker(); $('picker').style.display='flex'; }
function closePicker(){ $('picker').style.display='none'; }
function buildPicker(){
  const left=$('pickLeft'), right=$('pickRight'), rm=S.rankMap, chosen=new Set(S.selected);
  // Left: games not chosen
  left.innerHTML = S.allGames.filter(g=>!chosen.has(g.id)).map(g=>{
    const rH=rm.get(g.home.name), rA=rm.get(g.away.name);
    const hint=(rH||rA)? ` <span class="small">(Rk ${Math.min(rH||99,rA||99)})</span>`:'';
    return `<div class="pickrow"><div><strong>${g.home.name}</strong> vs <strong>${g.away.name}</strong>${hint}</div><button class="btn" data-add="${g.id}">Add</button></div>`;
  }).join('');
  // Right: selected order
  const map=new Map(S.allGames.map(g=>[g.id,g]));
  right.innerHTML = S.selected.map((id,i)=>{
    const g=map.get(id); if(!g) return '';
    const rH=rm.get(g.home.name), rA=rm.get(g.away.name);
    const hint=(rH||rA)? ` <span class="small">(Rk ${Math.min(rH||99,rA||99)})</span>`:'';
    return `<div class="orderrow" data-id="${id}">
      <div><span class="pill">#${i+1}</span> <strong>${g.home.name}</strong> vs <strong>${g.away.name}</strong>${hint}</div>
      <div class="row">
        <button class="btn" data-up="${id}">↑</button>
        <button class="btn" data-down="${id}">↓</button>
        <button class="btn" data-rem="${id}">Remove</button>
      </div>
    </div>`;
  }).join('');
}
// single delegated listener using .closest() so clicks on button edges still register
document.addEventListener('click',(ev)=>{
  const picker=$('picker'); if(!picker) return;

  // actions (top bar)
  const actEl = ev.target.closest('[data-action]');
  if(actEl && picker.contains(actEl)){
    const a=actEl.dataset.action;
    if(a==='close'){ closePicker(); return; }
    if(a==='clear'){ S.selected=[]; buildPicker(); return; }
    if(a==='top25'){
      const rm=S.rankMap;
      const ranked=S.allGames
        .filter(g=>rm.has(g.home.name)||rm.has(g.away.name))
        .map(g=>({g,rank:Math.min(rm.get(g.home.name)||99, rm.get(g.away.name)||99)}))
        .sort((a,b)=>a.rank-b.rank).map(x=>x.g.id).slice(0,10);
      S.selected=ranked; buildPicker(); return;
    }
    if(a==='apply'){
      const map=new Map(S.allGames.map(g=>[g.id,g]));
      S.games=S.selected.map(id=>map.get(id)).filter(Boolean).slice(0,10);
      closePicker(); render(); return;
    }
  }

  // Add / Remove / Up / Down (use closest)
  const addBtn = ev.target.closest('button[data-add]');
  const remBtn = ev.target.closest('button[data-rem]');
  const upBtn  = ev.target.closest('button[data-up]');
  const dnBtn  = ev.target.closest('button[data-down]');

  if(addBtn && picker.contains(addBtn)){
    const id=addBtn.dataset.add; if(!S.selected.includes(id) && S.selected.length<10){ S.selected.push(id); buildPicker(); }
  } else if(remBtn && picker.contains(remBtn)){
    const id=remBtn.dataset.rem; S.selected=S.selected.filter(x=>x!==id); buildPicker();
  } else if(upBtn && picker.contains(upBtn)){
    const id=upBtn.dataset.up; const i=S.selected.indexOf(id); if(i>0){ [S.selected[i-1],S.selected[i]]=[S.selected[i],S.selected[i-1]]; buildPicker(); }
  } else if(dnBtn && picker.contains(dnBtn)){
    const id=dnBtn.dataset.down; const i=S.selected.indexOf(id); if(i>=0 && i<S.selected.length-1){ [S.selected[i+1],S.selected[i]]=[S.selected[i],S.selected[i+1]]; buildPicker(); }
  }
});

/* -------- wire controls -------- */
$('thisWeek').onclick=resolveWeek;
$('testKey').onclick=async()=>{ try{ await cfbd('/info'); setStatus('Key OK',true);}catch(e){ setStatus('Key failed: '+e.message); } };
$('start').onclick=async()=>{ try{ saveKey(); await loadData(); startTimers(); }catch(e){ setStatus(e.message,false); } };
$('stop').onclick=()=>{ stopTimers(); setStatus('stopped'); };
$('logosToggle').onchange=()=>render();
$('pickBtn').onclick=openPicker;

loadKey();
</script>
</body>
</html>
